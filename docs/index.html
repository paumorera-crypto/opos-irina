<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Oposicions educadora social</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1d7a3e">
<link rel="icon" href="icons/icon-192.png">

<style>
  :root{
    --bg:#faf7f2; --text:#2b2b2b; --muted:#5b5b5b;
    --acc:#1d7a3e; --acc2:#2aa164; --danger:#b42318;
    --border:#d7cfc2; --card:#fffaf2; --card2:#fff6e9;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg);}
  header{padding:18px 14px;border-bottom:1px solid var(--border);background:#fff}
  .head{max-width:1024px;margin:0 auto;display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px}
  h1{margin:0;font-size:1.25rem}
  .subtitle{margin:2px 0 0;color:var(--muted);font-size:.92rem}

  .app{max-width:1024px;margin:0 auto;padding:16px}
  .card{
    background: var(--card);
    background-image:
      repeating-linear-gradient(90deg, rgba(160,120,70,.06), rgba(160,120,70,.06) 4px, rgba(255,255,255,.06) 4px, rgba(255,255,255,.06) 12px),
      linear-gradient(180deg, rgba(120,80,40,.04), rgba(255,255,255,0));
    border:1px solid var(--border); border-radius:16px; padding:16px;
    box-shadow:0 8px 18px rgba(0,0,0,.05);
  }
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row > *{flex:1;min-width:240px}
  label{color:var(--muted);font-size:.9rem}
  input[type=file], select, input[type=number]{
    width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--text)
  }
  details{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  summary{padding:12px 14px;cursor:pointer;font-weight:600;background:#fffaf5}
  details .content{padding:12px 14px;border-top:1px solid var(--border);background:#fff}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;background:var(--acc);color:#fff;font-weight:700;cursor:pointer;transition:.2s}
  .btn:hover{transform:translateY(-1px);filter:brightness(1.04)}
  .btn.alt{background:#eae3d7;color:var(--text);border:1px solid var(--border)}
  .btn.warn{background:#b42318}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap}
  .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:.8rem;margin-right:8px;background:#fff}
  .hidden{display:none}
  .radios{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .radio{display:flex;gap:6px;align-items:center}
  .qcard{margin-top:12px;padding:16px;border-radius:14px;background:var(--card2);border:1px solid var(--border)}
  .qtitle{font-size:1rem;margin:0 0 8px}
  .topic{color:#5a5a8a;font-size:.9rem;margin-bottom:12px}
  .opts{display:grid;gap:10px}
  .opt{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;cursor:pointer;text-align:left;transition:.15s}
  .opt:hover{border-color:#c9bba6}
  .opt.correct{border-color:#2aa164;background:#e9f7ef}
  .opt.wrong{border-color:#d65b5b;background:#fde9e9}
  .meta{color:var(--muted);font-size:.9rem;margin-top:8px}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px;color:var(--muted);gap:10px}
  .progress{height:8px;background:#fff;border:1px solid var(--border);border-radius:999px;overflow:hidden;min-width:120px}
  .bar{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));width:0%}
  .center{text-align:center}
  .score{font-size:1.1rem}
  .list{margin-top:12px}
  .list .item{padding:10px;border-bottom:1px dashed #d4c7b4;background:#fff;border-radius:10px;margin-bottom:8px}
  .small{font-size:.9rem;color:var(--muted)}
  .timer{font-variant-numeric:tabular-nums}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .tag{display:inline-block;background:#fff;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:.8rem}
  .motivation{margin-top:10px;padding:10px;border:1px dashed var(--border);border-radius:10px;background:#fff;font-weight:600}
</style>
</head>
<body>
<header>
  <div class="head">
    <!-- LOGO: cercle degradat, cercle interior blanc, P.O.U, i llibre obert a sota -->
    <svg class="logo" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <linearGradient id="pouGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#22c55e"/>
          <stop offset="1" stop-color="#3b82f6"/>
        </linearGradient>
      </defs>
      <!-- cercle exterior -->
      <circle cx="60" cy="60" r="56" fill="url(#pouGrad)" stroke="#1f2837" stroke-width="2"/>
      <!-- cercle interior blanc -->
      <circle cx="60" cy="60" r="48" fill="#ffffff" />
      <!-- inicials P.O.U -->
      <text x="60" y="42" text-anchor="middle" font-size="24" font-weight="800" fill="#1d7a3e" font-family="Segoe UI, Arial">P.O.U</text>
      <!-- Llibre obert (sense fulla) -->
      <g fill="#ffffff" stroke="#1d7a3e" stroke-width="2">
        <!-- p√†gina esquerra -->
        <path d="M60 64 L35 70 L35 82 L60 88" />
        <!-- p√†gina dreta -->
        <path d="M60 64 L85 70 L85 82 L60 88" />
        <!-- arcs inferiors -->
        <path d="M35 78 C45 84, 52 86, 60 88" fill="none"/>
        <path d="M60 88 C68 86, 75 84, 85 78" fill="none"/>
        <!-- columna central -->
        <path d="M60 64 L60 88"/>
      </g>
    </svg>
    <div>
      <h1>Oposicions educadora social</h1>
      <p class="subtitle">Pau & Oriol University</p>
    </div>
  </div>
</header>

<div class="app">
  <!-- SETUP -->
  <div class="card" id="screen-setup">
    <p style="margin-top:0">Hola Irina!<br>Carrega el banc de preguntes i escull un mode.</p>

    <details open>
      <summary>‚öôÔ∏è Configuraci√≥</summary>
      <div class="content">
        <div class="row">
          <div>
            <label>Carrega fitxer de preguntes</label>
            <input id="file" type="file" accept="application/json" />
            <div class="toolbar">
              <button class="btn alt" id="saveBank" disabled>Desa el banc al dispositiu</button>
              <button class="btn alt" id="clearBank" disabled>Esborra banc desat</button>
              <span class="small" id="bankInfo"></span>
            </div>
          </div>

          <div>
            <label>Tem√†tica</label>
            <div class="radios">
              <label class="radio"><input type="radio" name="scope" value="general" checked> General (tots els temes)</label>
              <label class="radio"><input type="radio" name="scope" value="specific"> Espec√≠fica (selecciona temes)</label>
            </div>
            <label style="margin-top:8px">Selecciona temes (Ctrl/Cmd per multi)</label>
            <select id="topicSelect" multiple size="6" disabled></select>
            <div class="toolbar">
              <button class="btn alt" id="clearTopics" disabled>Neteja selecci√≥</button>
              <span class="small" id="topicCount"></span>
            </div>
          </div>

          <div>
            <label>Temporitzador Examen (minuts)</label>
            <input id="examMinutes" type="number" min="5" max="180" step="5" value="30" />
            <div class="row" style="margin-top:8px">
              <div>
                <label># preguntes Test r√†pid</label>
                <input id="nQuick" type="number" min="5" max="50" step="1" value="10" />
              </div>
              <div>
                <label># preguntes Rep√†s</label>
                <input id="nReview" type="number" min="5" max="50" step="1" value="10" />
              </div>
              <div>
                <label># preguntes Examen</label>
                <input id="nExam" type="number" min="10" max="100" step="5" value="30" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </details>

    <div class="btnRow" style="margin-top:12px">
      <button class="btn" id="btn-quick" disabled>Test r√†pid</button>
      <button class="btn" id="btn-exam" disabled>Examen</button>
      <button class="btn" id="btn-review" disabled>Rep√†s intel¬∑ligent</button>
      <button class="btn alt" id="btn-stats" disabled>üìà Estad√≠stiques</button>
      <button class="btn alt" id="btn-errors" disabled>‚ö†Ô∏è Errors m√©s freq√ºents</button>
    </div>
  </div>

  <!-- QUIZ -->
  <div class="card hidden" id="screen-quiz">
    <div class="footer">
      <div><span class="pill" id="modeTag">Mode</span> <span id="counter" class="small"></span></div>
      <div style="flex:1"><div class="progress"><div class="bar" id="bar"></div></div></div>
      <div class="small timer" id="timer"></div>
    </div>

    <div class="qcard">
      <div class="topic" id="topic"></div>
      <h2 class="qtitle" id="qtitle"></h2>
      <div class="opts" id="opts"></div>
      <div class="meta" id="ref"></div>
    </div>

    <div class="footer">
      <button class="btn alt" id="skip">Saltar</button>
      <button class="btn" id="next" disabled>Seg√ºent</button>
    </div>
  </div>

  <!-- RESULT -->
  <div class="card hidden" id="screen-result">
    <div class="center">
      <p class="score" id="finalScore"></p>
      <div id="motivation" class="motivation"></div>
      <div class="btnRow" style="justify-content:center;margin-top:10px">
        <button class="btn" id="again">Tornar al men√∫</button>
      </div>
    </div>
    <div class="list" id="reviewList"></div>
  </div>

  <!-- STATS -->
  <div class="card hidden" id="screen-stats">
    <h3 style="margin-top:0">üìà Estad√≠stiques</h3>
    <div id="statsSummary" class="small"></div>
    <div class="list" id="statsTopics"></div>
    <div class="list" id="statsWorst"></div>
    <div class="btnRow">
      <button class="btn warn" id="clearStats">Reiniciar estad√≠stiques</button>
      <button class="btn alt" id="backFromStats">Tornar</button>
    </div>
  </div>

  <!-- ERRORS -->
  <div class="card hidden" id="screen-errors">
    <h3 style="margin-top:0">‚ö†Ô∏è Errors m√©s freq√ºents</h3>
    <p class="small">Ordenat per pitjor ratio. Pots filtrar temes a Configuraci√≥.</p>
    <div class="list" id="errorsList"></div>
    <div class="btnRow"><button class="btn alt" id="backFromErrors">Tornar</button></div>
  </div>
</div>

<script>
/* ---------- Estat global ---------- */
let BANK = [];
let BANK_FILT = [];
let ORDER = [];
let MODE = "";
let LIMIT = 0;
let POS = 0;
let SCORE = 0;
let ANSW = {};
let TIMER = null;
let TIME_END = 0;

const LS_STATS = "opos_stats_v1";
const LS_BANK  = "opos_bank_v1";

/* ---------- Helpers UI ---------- */
const el = id => document.getElementById(id);
const sSetup  = el("screen-setup");
const sQuiz   = el("screen-quiz");
const sRes    = el("screen-result");
const sStats  = el("screen-stats");
const sErrors = el("screen-errors");
function show(view){ [sSetup,sQuiz,sRes,sStats,sErrors].forEach(x=>x.classList.add("hidden")); view.classList.remove("hidden"); }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function randPick(n, tot){ const a=[...Array(tot).keys()]; return shuffle(a).slice(0,Math.min(n,tot)); }

/* ---------- Hash i stats ---------- */
function hashQ(q){ let h=0; for(let i=0;i<q.length;i++){ h=((h<<5)-h)+q.charCodeAt(i); h|=0; } return String(h); }
function loadStats(){ try{ return JSON.parse(localStorage.getItem(LS_STATS)||"{}"); }catch{ return {}; } }
function saveStats(s){ localStorage.setItem(LS_STATS, JSON.stringify(s)); }
function resetStats(){ localStorage.removeItem(LS_STATS); }
function updateStatForQuestion(qText, ok){
  const id = hashQ(qText);
  const s = loadStats();
  const rec = s[id] || {seen:0, ok:0, ko:0, last:null, q:qText};
  rec.seen += 1; if(ok) rec.ok += 1; else rec.ko += 1;
  rec.last = new Date().toISOString().slice(0,19);
  s[id] = rec; saveStats(s);
}

/* ---------- Banc (guardar/auto-carregar) ---------- */
function loadSavedBank(){
  try{ const raw = localStorage.getItem(LS_BANK); if(!raw) return null; const arr = JSON.parse(raw); if(Array.isArray(arr)) return arr; }catch{}
  return null;
}
function saveBankToDevice(){
  if(!BANK.length){ alert("Carrega un banc primer."); return; }
  localStorage.setItem(LS_BANK, JSON.stringify(BANK));
  el("bankInfo").textContent = `üíæ Banc desat al dispositiu (${BANK.length} preguntes).`;
  el("clearBank").disabled = false;
}
function clearSavedBank(){
  localStorage.removeItem(LS_BANK);
  el("bankInfo").textContent = "Banc desat esborrat.";
  el("clearBank").disabled = true;
}

/* ---------- Temes i filtre ---------- */
function topicsFromBank(arr){ const set=new Set(); arr.forEach(q=>{ if(q.topic) set.add(q.topic); }); return [...set].sort((a,b)=>a.localeCompare(b)); }
function fillTopicSelect(){
  const sel = el("topicSelect"); sel.innerHTML = "";
  topicsFromBank(BANK).forEach(t=>{ const o=document.createElement("option"); o.value=t; o.textContent=t; sel.appendChild(o); });
  el("topicCount").textContent = `Temes detectats: ${topicsFromBank(BANK).length}`;
}
function getSelectedTopics(){ const sel = el("topicSelect"); return [...sel.options].filter(o=>o.selected).map(o=>o.value); }
function getScope(){ return document.querySelector('input[name="scope"]:checked').value; }
function applyFilter(){
  const scope = getScope();
  if(scope==="general"){
    BANK_FILT = BANK.slice(); el("topicSelect").disabled = true; el("clearTopics").disabled = true;
  }else{
    el("topicSelect").disabled = false; el("clearTopics").disabled = false;
    const picked = getSelectedTopics();
    BANK_FILT = picked.length ? BANK.filter(q => picked.includes(q.topic||"")) : [];
  }
}

/* ---------- Temporitzador ---------- */
function setTimer(minutes){
  clearInterval(TIMER);
  if(MODE!=="exam"){ el("timer").textContent = ""; return; }
  TIME_END = Date.now() + minutes*60*1000;
  TIMER = setInterval(()=>{
    const remain = TIME_END - Date.now();
    if(remain <= 0){ clearInterval(TIMER); el("timer").textContent = "00:00"; finish(); return; }
    const m = Math.floor(remain/60000), s = Math.floor((remain%60000)/1000);
    el("timer").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }, 250);
}

/* ---------- Motivaci√≥ ---------- */
const QUOTES = {
  high: [
    "Brutal! üëë Aquest nivell ja √©s premium.",
    "Excel¬∑lent! Mant√©n el ritme, la pla√ßa t‚Äôespera.",
    "Molt top! Suma const√†ncia i ja ho tens.",
    "Coneixement + calma = vict√≤ria."
  ],
  mid: [
    "Molt b√©! üí™ Vas pel bon cam√≠.",
    "Bon resultat! Un parell de repassos i pujar√†.",
    "Solidesa! Polim detalls i endavant.",
    "Cada test suma, continua aix√≠!"
  ],
  low: [
    "No passa res! üöÄ Els errors marquen el cam√≠ del rep√†s.",
    "√Änims! Avui aprens; dem√† ho claves.",
    "Pas a pas. Repassa les errades i torna-hi.",
    "La const√†ncia guanya. Fem un rep√†s intel¬∑ligent?"
  ]
};
function pickQuote(pct){
  const arr = pct>=80? QUOTES.high : pct>=50? QUOTES.mid : QUOTES.low;
  return arr[Math.floor(Math.random()*arr.length)];
}

/* ---------- Flux del Quiz ---------- */
function loadQuestion(){
  const idx = ORDER[POS];
  const q = BANK_FILT[idx];
  el("modeTag").textContent = MODE==="quick"?"Test r√†pid":MODE==="exam"?"Examen":"Rep√†s";
  el("counter").textContent = `Preg ${POS+1}/${LIMIT}`;
  el("bar").style.width = `${Math.round((POS)/LIMIT*100)}%`;
  el("topic").textContent = q.topic ? `üìò Tema: ${q.topic}` : "üìò";
  el("qtitle").textContent = q.q;
  el("opts").innerHTML = "";
  q.options.forEach((op, i) => {
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.textContent = `${i+1}) ${op}`;
    btn.onclick = () => selectAnswer(i, q.answer);
    el("opts").appendChild(btn);
  });
  el("ref").textContent = q.ref ? `‚ÑπÔ∏è ${q.ref}` : "";
  el("next").disabled = true;
}
function selectAnswer(sel, correct){
  [...el("opts").children].forEach((b, i)=>{
    b.disabled = true;
    if(i===correct) b.classList.add("correct");
    if(i===sel && sel!==correct) b.classList.add("wrong");
  });
  const q = BANK_FILT[ORDER[POS]];
  const ok = sel===correct;
  if(ok) SCORE++;
  ANSW[ORDER[POS]] = sel;
  updateStatForQuestion(q.q, ok);
  el("next").disabled = false;
}
function nextQ(){
  POS++; el("bar").style.width = `${Math.round((POS)/LIMIT*100)}%`;
  if(POS>=LIMIT){ finish(); return; }
  loadQuestion();
}
function finish(){
  clearInterval(TIMER);
  show(sRes);
  const pct = LIMIT? Math.round(SCORE/LIMIT*100):0;
  el("finalScore").textContent = `Resultat: ${SCORE}/${LIMIT} ¬∑ ${pct}%`;
  el("motivation").textContent = pickQuote(pct);
  const ul = el("reviewList"); ul.innerHTML = "";
  ORDER.slice(0,LIMIT).forEach((subIdx, n)=>{
    const q = BANK_FILT[subIdx]; const user = ANSW[subIdx]; const ok = user===q.answer;
    const div = document.createElement("div"); div.className = "item";
    div.innerHTML = `<div class="small"><b>${n+1}.</b> ${q.q}</div>
      <div class="small">${ok?'‚úÖ':'‚ùå'} Correcta: ${q.answer+1}) ${q.options[q.answer]}${user!=null?` ¬∑ Teva: ${user+1}) ${q.options[user]}`:''}</div>
      ${q.ref?`<div class="small">‚ÑπÔ∏è ${q.ref}</div>`:""}`;
    ul.appendChild(div);
  });
}

/* ---------- Estad√≠stiques i Errors ---------- */
function statsForBank(arr){
  const stats = loadStats(), total={seen:0,ok:0,ko:0}, perTopic={};
  arr.forEach(q=>{
    const r = stats[hashQ(q.q)]; if(!r) return;
    total.seen+=r.seen; total.ok+=r.ok; total.ko+=r.ko;
    const t=q.topic||"(sense tema)"; perTopic[t]=perTopic[t]||{seen:0,ok:0,ko:0};
    perTopic[t].seen+=r.seen; perTopic[t].ok+=r.ok; perTopic[t].ko+=r.ko;
  });
  return {total, perTopic, stats};
}
function renderStats(){
  const {total, perTopic} = statsForBank(BANK);
  const seen=total.seen||0, ok=total.ok||0, ko=total.ko||0, pct = seen?Math.round(ok/seen*100):0;
  el("statsSummary").innerHTML = `
    <div class="tag">Vistes: <b>${seen}</b></div>
    <div class="tag">Correctes: <b>${ok}</b></div>
    <div class="tag">Errors: <b>${ko}</b></div>
    <div class="tag">% encerts global: <b>${pct}%</b></div>`;
  const topicsDiv = el("statsTopics"); topicsDiv.innerHTML = "<h4>Per temes</h4>";
  Object.keys(perTopic).sort().forEach(t=>{
    const r = perTopic[t], p = r.seen? Math.round(r.ok/r.seen*100):0;
    const d = document.createElement("div"); d.className="item";
    d.innerHTML = `<b>${t}</b><br><span class="small">Vistes ${r.seen} ¬∑ OK ${r.ok} ¬∑ KO ${r.ko} ¬∑ ${p}% encerts</span>`;
    topicsDiv.appendChild(d);
  });
  const stats = loadStats();
  const arr = BANK.map(q=>{
    const r = stats[hashQ(q.q)] || {seen:0,ok:0,ko:0};
    const ratio = r.seen? (r.ko/r.seen):0;
    return {q, r, ratio};
  }).filter(x=>x.r.seen>0).sort((a,b)=> b.ratio - a.ratio || a.r.seen - b.r.seen);
  const worstDiv = el("statsWorst"); worstDiv.innerHTML = "<h4>√Ärees a refor√ßar (Top 5)</h4>";
  arr.slice(0,5).forEach(x=>{
    const d = document.createElement("div"); d.className="item";
    const pctKo = Math.round(x.r.ko/x.r.seen*100);
    d.innerHTML = `<b>${x.q.q}</b><br><span class="small">Tema: ${x.q.topic||'-'} ¬∑ Vistes ${x.r.seen} ¬∑ KO ${x.r.ko} (${pctKo}%)</span>`;
    worstDiv.appendChild(d);
  });
}
function renderErrors(){
  const stats = loadStats();
  const rows = BANK_FILT.map(q=>{
    const r = stats[hashQ(q.q)] || {seen:0,ok:0,ko:0};
    const ratio = r.seen? (r.ko/r.seen):0;
    return {q, r, ratio};
  }).filter(x=>x.r.seen>0).sort((a,b)=> b.ratio - a.ratio || a.r.seen - b.r.seen);
  const list = el("errorsList"); list.innerHTML = "";
  rows.forEach((x, n)=>{
    const d = document.createElement("div"); d.className="item";
    const pctKo = Math.round(x.r.ko/x.r.seen*100);
    d.innerHTML = `<b>${n+1}.</b> ${x.q.q}
      <div class="small">Tema: ${x.q.topic||'-'} ¬∑ Vistes ${x.r.seen} ¬∑ KO ${x.r.ko} (${pctKo}% errors) ${x.q.ref?`¬∑ Ref: ${x.q.ref}`:''}</div>`;
    list.appendChild(d);
  });
  if(!rows.length){ list.innerHTML = `<div class="item"><span class="small">Encara no hi ha prou respostes. Fes alguns tests.</span></div>`; }
}

/* ---------- Arrencada i events ---------- */
function enableMainButtons(on){ ["btn-quick","btn-exam","btn-review","btn-stats","btn-errors","saveBank","clearBank"].forEach(id=> el(id).disabled=!on); }
function onBankLoaded(){
  fillTopicSelect(); applyFilter(); enableMainButtons(true);
  el("bankInfo").textContent = `Banc carregat (${BANK.length} preguntes).`;
}
el("file").addEventListener("change", async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try{
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error("El fitxer ha de ser una llista d'objectes.");
    BANK = arr.filter(q => q && q.q && Array.isArray(q.options) && q.options.length===4 && Number.isInteger(q.answer));
    if(!BANK.length) throw new Error("No s'han trobat preguntes v√†lides.");
    onBankLoaded();
    alert(`üìö S'han carregat ${BANK.length} preguntes. Temes: ${topicsFromBank(BANK).length}.`);
  }catch(err){ alert("Error llegint el fitxer: " + err.message); }
});
document.querySelectorAll('input[name="scope"]').forEach(r=> r.addEventListener("change", applyFilter));
el("topicSelect").addEventListener("change", applyFilter);
el("clearTopics").addEventListener("click", ()=>{ const s=el("topicSelect"); [...s.options].forEach(o=>o.selected=false); applyFilter(); });
el("saveBank").onclick  = saveBankToDevice;
el("clearBank").onclick = clearSavedBank;

function start(mode){
  MODE = mode; applyFilter();
  if(!BANK_FILT.length){ alert("No hi ha preguntes per a la selecci√≥ actual."); return; }
  const nQuick  = Math.max(5, Math.min(50,  parseInt(el("nQuick").value  || "10", 10)));
  const nReview = Math.max(5, Math.min(50,  parseInt(el("nReview").value || "10", 10)));
  const nExam   = Math.max(10,Math.min(100, parseInt(el("nExam").value   || "30", 10)));
  LIMIT = MODE==="quick" ? Math.min(nQuick,  BANK_FILT.length)
        : MODE==="review"? Math.min(nReview, BANK_FILT.length)
        :                  Math.min(nExam,   BANK_FILT.length);
  ORDER = randPick(LIMIT, BANK_FILT.length);
  POS = 0; SCORE = 0; ANSW = {};
  show(sQuiz);
  if(MODE==="exam"){
    const mins = Math.max(5, Math.min(180, parseInt(el("examMinutes").value || "30", 10)));
    setTimer(mins);
  } else { el("timer").textContent = ""; }
  loadQuestion();
}
el("btn-quick").onclick = ()=> start("quick");
el("btn-exam").onclick  = ()=> start("exam");
el("btn-review").onclick= ()=> start("review");
el("skip").onclick      = ()=> { ANSW[ORDER[POS]] = null; nextQ(); }
el("next").onclick      = nextQ;
el("again").onclick     = ()=> { show(sSetup); };
el("btn-stats").onclick = ()=> { renderStats(); show(sStats); };
el("backFromStats").onclick = ()=> show(sSetup);
el("clearStats").onclick = ()=>{ if(confirm("Segur que vols esborrar totes les estad√≠stiques locals?")){ resetStats(); renderStats(); } };
el("btn-errors").onclick = ()=> { applyFilter(); renderErrors(); show(sErrors); };
el("backFromErrors").onclick = ()=> show(sSetup);

/* Auto-carrega banc desat si existeix */
(function init(){
  const saved = loadSavedBank();
  if(saved && saved.length){ BANK = saved; onBankLoaded(); el("bankInfo").textContent = `üíæ Carregat autom√†ticament (desat): ${BANK.length} preguntes.`; }
  else { enableMainButtons(false); el("bankInfo").textContent = "Cap banc desat. Carrega un fitxer per comen√ßar."; }
})();
</script>

<!-- Registre del Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>
</body>
</html>